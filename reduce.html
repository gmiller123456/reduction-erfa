<html>
<head>
	<title>Reduction</title>
</head>
<body>
<h1>Reduction</h1>
<script src="ascp2000.405.js"></script>
<script src="de405.js"></script>
<script src="iau2000a.js"></script>

<form>
Julian Date:<input id='jdInput' type=text value=2458850.5><input type=button value="Compute" onclick='computeValues();'><br>

<script>

const au= 149597870.691;
const T0 = 2451545.00000000;
const ASEC360 = 1296000.0;
const ASEC2RAD = 4.848136811095359935899141e-6;
const TWOPI=Math.PI*2;


const year = 2008;
const month = 4;
const day = 24;
const hour = 10; //10.605
const min = 36;
const sec = 18;

const ut1_utc = -0.387845;
const leap_secs = 33;

const de=new DE405();

reduce();

function reduce(){
	const jd_utc=dateToJulianDate(year,month,day,hour,min,sec);
	const jd_tt = jd_utc + (leap_secs + 32.184) / 86400.0;
	const jd_ut1 = jd_utc + ut1_utc / 86400.0;
	const delta_t = 32.184 + leap_secs - ut1_utc;

	const jd_tdb=tt2tdb(jd_tt);

	const earth=de.getEarth(jd_tdb);
	const sun=de.getAllPropertiesForSeries(10,jd_tdb);

	const geopv=geo_posvel(jd_tt,delta_t);

	//TODO: ...
}

function geo_posvel(jd_tt,delta_t){
	const jd_tdb=tt2tdb(jd_tt);
	const jd_ut1 = jd_tt - (delta_t / 86400.0);

	const gmst=sidereal_time (jd_ut1,delta_t,0,1);
	const eqeq=e_tilt(jd_tdb);

	//TODO: ...
}

function e_tilt(jd_tdb){
	const t = (jd_tdb - T0) / 36525.0;

	nutation_angles(t);
	//TODO:...

}

function nutation_angles (t){
	const t1 = t * 36525.0;

	const angles=iau2000a (T0,t1);

   angles[0] /= ASEC2RAD; //dpsi
   angles[1] /= ASEC2RAD; //deps

   console.log(angles);

   return angles;
}


function sidereal_time(jd_ut,delta_t,gst_type,method){
	const jd_tt = jd_ut + (delta_t / 86400.0);
	theta = era (jd_ut,0);
	const jd_tdb=tt2tdb(jd_tt);
	t = (jd_tdb - T0) / 36525.0;

	let eqeq=0.0;

	switch(method){
		case 0:
			break;
		case 1:
		         const st = eqeq + 0.014506 +
               (((( -    0.0000000368   * t
                    -    0.000029956  ) * t
                    -    0.00000044   ) * t
                    +    1.3915817    ) * t
                    + 4612.156534     ) * t;

         var gst = fmod ((st / 3600.0 + theta), 360.0) / 15.0;

         if (gst < 0.0)
            gst += 24.0;
               return gst;
	}

	//TODO: ...
}

function era(jd_high,jd_low){
   var theta, thet1, thet2, thet3;

   thet1 = 0.7790572732640 + 0.00273781191135448 * (jd_high - T0);
   thet2 = 0.00273781191135448 * jd_low;
   thet3 = fmod (jd_high, 1.0) + fmod (jd_low, 1.0);

   theta = fmod (thet1 + thet2 + thet3, 1.0) * 360.0;
   if (theta < 0.0)
      theta += 360.0;

   return theta;	
}

function fund_args (t,a)
{

   a[0] = fmod (485868.249036 +
             t * (1717915923.2178 +
             t * (        31.8792 +
             t * (         0.051635 +
             t * (       - 0.00024470)))), ASEC360) * ASEC2RAD;

   a[1] = fmod (1287104.79305 +
             t * ( 129596581.0481 +
             t * (       - 0.5532 +
             t * (         0.000136 +
             t * (       - 0.00001149)))), ASEC360) * ASEC2RAD;

   a[2] = fmod (335779.526232 +
             t * (1739527262.8478 +
             t * (      - 12.7512 +
             t * (      -  0.001037 +
             t * (         0.00000417)))), ASEC360) * ASEC2RAD;

   a[3] = fmod (1072260.70369 +
             t * (1602961601.2090 +
             t * (       - 6.3706 +
             t * (         0.006593 +
             t * (       - 0.00003169)))), ASEC360) * ASEC2RAD;

   a[4] = fmod (450160.398036 +
             t * ( - 6962890.5431 +
             t * (         7.4722 +
             t * (         0.007702 +
             t * (       - 0.00005939)))), ASEC360) * ASEC2RAD;

   return;
}

function fmod(a,b){
	return a%b;
}

function tt2tdb(jd_tt){
	/*From Novas*/
	const t = (jd_tt - T0) / 36525.0;

	const secdiff = 0.001657 * Math.sin ( 628.3076 * t + 6.2401)
		+ 0.000022 * Math.sin ( 575.3385 * t + 4.2970)
		+ 0.000014 * Math.sin (1256.6152 * t + 6.1969)
		+ 0.000005 * Math.sin ( 606.9777 * t + 4.0212)
		+ 0.000005 * Math.sin (  52.9691 * t + 0.4444)
		+ 0.000002 * Math.sin (  21.3299 * t + 5.5431)
		+ 0.000010 * t * Math.sin ( 628.3076 * t + 4.2490);

	return jd_tt+secdiff/ 86400.0;
}

function INT(d){
	if(d>0){
		return Math.floor(d);
	}
	return Math.floor(d)-1;
}

function dateToJulianDate(year, month, day, hour, min, sec){
	//From Meeus p61 (7.1)
	/*
	let year=date.getUTCFullYear();
	let month=date.getUTCMonth()+1;
	let day=date.getUTCDate();
	let hour=date.getUTCHours();
	let min=date.getUTCMinutes();
	let sec=date.getUTCSeconds();
*/
	let isGregorian=true;
	if(year<1582 || (year == 1582 && (month < 10 || (month==10 && day < 5)))){
		isGregorian=false;
	}

	if (month < 3){
		year = year - 1;
		month = month + 12;
	}

	let b = 0;
	if (isGregorian){
	let a = INT(year / 100.0);
		b = 2 - a + INT(a / 4.0);
	}

	let jd=INT(365.25 * (year + 4716)) + INT(30.6001 * (month + 1)) + day + b - 1524.5;
	jd+=hour/24.0;
	jd+=min/24.0/60.0;
	jd+=sec/24.0/60.0/60.0;
	return jd;
}




</script>



</body>
</html>
